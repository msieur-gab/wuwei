<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Le reste du head reste inchangé] -->
</head>
<body>
    <!-- [Le corps du HTML reste inchangé] -->

    <script>
        // [Les autres déclarations de variables restent inchangées]

        const SOUNDS_PATH = 'sounds/';

        const sounds = {
            slow: ['slow1.mp3', 'slow2.mp3', 'slow3.mp3'],
            medium: ['medium1.mp3', 'medium2.mp3', 'medium3.mp3'],
            fast: ['fast1.mp3', 'fast2.mp3', 'fast3.mp3']
        };

        let currentSounds = [];
        let audioElements = [];
        let isPlaying = false;

        startButton.addEventListener('click', startDetection);
        playPauseButton.addEventListener('click', togglePlayPause);

        // [Les autres fonctions restent inchangées]

        async function startDetection() {
            // Arrêter les sons en cours
            stopAllSounds();
            
            // Réinitialiser l'interface utilisateur
            playPauseButton.disabled = true;
            playPauseButton.textContent = "Play";
            isPlaying = false;
            bpmDisplay.textContent = "BPM: --";

            try {
                log("Starting detection...");
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });
                
                video.srcObject = stream;
                video.play();

                // Activate flash
                track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                if (capabilities.torch) {
                    await track.applyConstraints({
                        advanced: [{ torch: true }]
                    });
                    log("Flash activated");
                } else {
                    log("Flash is not available on this device.");
                }

                startButton.disabled = true;
                heartRateData = [];
                detectionStartTime = Date.now();
                detectionInterval = setInterval(processFrame, 30); // About 30 FPS
                updateProgress();

                log("Detection started");
            } catch (err) {
                log("Camera access error: " + err.message);
            }
        }

        function stopAllSounds() {
            audioElements.forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
            audioElements = [];
            currentSounds = [];
            log("All sounds stopped");
        }

        function stopDetection() {
            clearInterval(detectionInterval);
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            const bpm = calculateBPM(heartRateData);
            bpmDisplay.textContent = `BPM: ${bpm}`;
            updateSounds(bpm);
            
            startButton.disabled = false;
            playPauseButton.disabled = false;
            progressBar.value = 100;
            
            log("Detection completed");
        }

        // [Les autres fonctions restent inchangées]

        function loadSounds() {
            audioElements = currentSounds.map(sound => {
                const audio = new Audio(SOUNDS_PATH + sound);
                audio.loop = true;
                audio.onerror = () => log("Error loading sound: " + sound);
                audio.onloadeddata = () => log("Sound loaded: " + sound);
                return audio;
            });
        }

        function togglePlayPause() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                playSounds();
                playPauseButton.textContent = "Pause";
            } else {
                pauseSounds();
                playPauseButton.textContent = "Play";
            }
        }

        function playSounds() {
            audioElements.forEach(audio => {
                audio.play().then(() => log("Playback started: " + audio.src))
                            .catch(err => log("Playback error: " + audio.src + " - " + err.message));
            });
        }

        function pauseSounds() {
            audioElements.forEach(audio => {
                audio.pause();
                log("Sound paused: " + audio.src);
            });
        }
    </script>
</body>
</html>
